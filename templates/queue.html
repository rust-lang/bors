{% extends "base.html" %}

{% block title %}Bors queue - {{ repo_name }} {% if tree_state.is_closed() %} [TREECLOSED] {% endif %}{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.3.4/css/dataTables.dataTables.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.5.1/css/rowGroup.dataTables.min.css" />
<style>
    main {
        max-width: 100rem;
        width: 100%;
        margin: 0 auto;
    }

    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        min-width: 100%;
        white-space: nowrap;
    }

    table th,
    table td {
        padding: 0.5rem;
    }

    th.select-checkbox,
    td.select-checkbox {
        width: 2.5rem;
    }

    #rollupModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    #rollupModalContent {
        background-color: white;
        margin: 15% auto;
        padding: 1rem;
        border: 1px solid black;
        max-width: 500px;
    }

    #rollupModalClose {
        float: right;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block body %}
<main>
  <h1>
    Bors queue - <a href="{{ repo_url }}" target="_blank">{{ repo_name }}</a>
    {% if tree_state.is_closed() %}
    {% if let Some(comment_source) = tree_state.comment_source() %}
    {% if let Some(priority) = tree_state.priority() %}
    [<a href="{{ comment_source }}">TREECLOSED</a> below priority {{ priority }}]
    {% endif %}
    {% endif %}
    {% endif %}
  </h1>

  <p><a href="/help">Help page</a></p>

  <p>
    {{ stats.total_count }} total, {{ stats.in_queue_count }} in queue,
    {{ stats.failed_count }} failed, {{ stats.rolled_up_count }} rolled up
  </p>

  <div style="margin-bottom: 1rem;">
    <label for="groupBy">Group by: </label>
    <select id="groupBy">
      <option value="">None</option>
      <option value="2">Status</option>
      <option value="3">Mergeable</option>
      <option value="5">Author</option>
      <option value="8">Priority</option>
    </select>
    <button id="showRollupSelection" style="margin-left: 1rem;">Create rollup</button>
  </div>

  <div class="table-wrapper">
    <table id="table">
        <thead>
            <tr>
                <th class="select-checkbox"></th>
                <th>#</th>
                <th>Status</th>
                <th>Mergeable</th>
                <th>Title</th>
                <th>Author</th>
                <th>Assignees</th>
                <th>Approved by</th>
                <th>Priority</th>
                <th>Rollup</th>
            </tr>
        </thead>

        <tbody>
            {% for pr in prs %}
            <tr>
                <td class="select-checkbox"></td>
                <td>
                    <a href="{{ repo_url }}/pull/{{ pr.number }}">{{ pr.number.0 }}</a>
                </td>
                <td data-status="{{ crate::templates::status_text(pr) }}">
                    {% if let Some(try_build) = pr.try_build %}
                    <a href="../results/{{ repo_name }}/{{ pr.number }}">{{ crate::templates::status_text(pr) }}</a> (try)
                    {% else %}
                    {{ crate::templates::status_text(pr) }}
                    {% endif %}
                </td>
                <td>
                    {% match pr.mergeable_state %}
                    {% when Mergeable %}
                    yes
                    {% when HasConflicts %}
                    no
                    {% when Unknown %}
                    {% endmatch %}
                </td>
                <td>{{ pr.title }}</td>
                <td>{{ pr.author }}</td>
                <td>{{ pr.assignees|join(", ") }}</td>
                <td>
                    {% if let Some(approver) = pr.approver() %}
                    {{ approver }}
                    {% endif %}
                </td>
                <td>{{ pr.priority.unwrap_or(0) }}</td>
                <td>
                    {% if let Some(rollup) = pr.rollup %}
                    {{ rollup }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
  </div>

  <div style="text-align: center; margin-top: 1em;">
    <a href="https://github.com/rust-lang/bors">Contribute on GitHub</a>
  </div>

  <div id="rollupModal">
    <div id="rollupModalContent">
      <span id="rollupModalClose">&times;</span>
      <p id="rollupModalMessage"></p>
      <button id="rollupModalContinue" style="display: none;">Continue</button>
    </div>
  </div>
</main>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.3.4/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/rowgroup/1.6.0/js/dataTables.rowGroup.min.js"></script>
<script src="https://cdn.datatables.net/select/3.1.3/js/dataTables.select.min.js"></script>

<script>
    const getDataStatusFromCell = (cell) => cell?.dataset?.status || '';
    const interactiveSelector = 'a, button, input, label, select, textarea';

    function initializeTable(colIndex) {
        let config = {
            paging: false,
            info: false,
            columnDefs: [
                {
                    targets: 0,
                    orderable: false,
                    className: 'select-checkbox',
                    render: DataTable.render.select()
                },
                {
                    targets: 2,     // Column 2 (Status column)
                    render: function(data, type, row, meta) {
                        if (type === 'display') {
                            return data;
                        }

                        // Use data-status for everything else
                        if (meta && meta.settings && meta.row !== undefined) {
                            let rowNode = meta.settings.aoData[meta.row]?.nTr;
                            if (rowNode) {
                                return getDataStatusFromCell(rowNode.cells[meta.col]);
                            }
                        }

                        return data;
                    }
                }
            ],
            order: [],
            select: {
                style: 'multi',
                selector: 'td.select-checkbox',
                headerCheckbox: true
            }
        };

        if (colIndex !== null) {
            config.order = [[colIndex, "asc"]];
            config.rowGroup = {
                dataSrc: colIndex === 2
                    ? ([_, html]) => {
                        let tableElement = document.getElementById('table');
                        if (tableElement && tableElement.tBodies[0]) {
                            let rows = Array.from(tableElement.tBodies[0].rows);
                            for (let row of rows) {
                                if (row.cells[2] && row.cells[2].innerHTML === html) {
                                    return getDataStatusFromCell(row.cells[2]);
                                }
                            }
                        }
                        return html;
                    }
                    : colIndex
            };
        }

        return new DataTable("#table", config);
    }

    function bindRowClick(tableInstance) {
        const tbody = document.querySelector('#table tbody');
        if (!tbody) {
            return () => {};
        }

        const handler = (event) => {
            // Ignore clicks on checkbox - let checkbox handle it
            if (event.target.closest('td.select-checkbox')) {
                return;
            }

            // Ignore clicks on interactive elements
            if (event.target.closest(interactiveSelector)) {
                return;
            }

            const rowElement = event.target.closest('tr');
            if (!rowElement) {
                return;
            }

            const rowApi = tableInstance.row(rowElement);
            if (!rowApi.any()) {
                return;
            }

            if (rowApi.selected()) {
                rowApi.deselect();
            } else {
                rowApi.select();
            }
        };

        tbody.addEventListener('click', handler);
        return () => tbody.removeEventListener('click', handler);
    }

    let table = initializeTable(null);
    let detachRowClick = bindRowClick(table);

    // Handle group by dropdown changes
    document.getElementById("groupBy").addEventListener("change", function() {
        let colIndex = this.value === "" ? null : parseInt(this.value, 10);
        table.destroy();
        detachRowClick();
        table = initializeTable(colIndex);
        detachRowClick = bindRowClick(table);
    });

    const modal = document.getElementById("rollupModal");
    const modalMessage = document.getElementById("rollupModalMessage");
    const modalClose = document.getElementById("rollupModalClose");
    const modalContinue = document.getElementById("rollupModalContinue");

    function closeModal() {
        modal.style.display = "none";
        modalContinue.style.display = "none";
    }

    modalClose.addEventListener("click", closeModal);
    modalContinue.addEventListener("click", closeModal);

    window.addEventListener("click", function(event) {
        if (event.target === modal) {
            closeModal();
        }
    });

    document.getElementById("showRollupSelection").addEventListener("click", function() {
        let selectedRows = table.rows({ selected: true }).nodes().toArray();
        let message;

        if (selectedRows.length === 0) {
            message = "No PRs selected for rollup.";
            modalContinue.style.display = "none";
        } else {
            message = `You've selected <strong>${selectedRows.length} PR(s)</strong> to be included in this rollup.<br><br>
            A rollup is useful for shortening the queue, but jumping the queue is unfair to older PRs who have waited too long.<br><br>
            When creating a real rollup, see the <a href="https://forge.rust-lang.org/release/rollups.html" target="_blank">instructions</a> for reference.`;
            modalContinue.style.display = "inline-block";
        }

        modalMessage.innerHTML = message;
        modal.style.display = "block";
    });
</script>
{% endblock %}
